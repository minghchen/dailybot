# Mac微信通道使用指南

本文档提供了在macOS上配置和使用 `mac_wechat` 通道的详细步骤。请在开始前仔细阅读，以确保顺利运行。

## 两种运行模式

`mac_wechat` 通道提供两种截然不同的运行模式，请根据你的需求和技术背景进行选择：

| 特性 | 🟢 静默模式 (默认) | 🔵 Hook模式 (实验性) |
| :--- | :--- | :--- |
| **工作原理** | 直接读取、解密本地微信数据库 | 集成第三方工具 `WeChatTweak-macOS` |
| **实时性** | 延迟 (取决于轮询间隔) | ✅ 实时 |
| **发送消息** | ❌ 不支持 | ✅ 支持 |
| **自动回复** | ❌ 不支持 | ✅ 支持 |
| **安全性** | ✅ **最高**。不修改微信，不注入代码。 | 依赖第三方工具，理论风险更高。 |
| **配置难度** | 较难。需要手动获取数据库密钥。 | 简单。依赖命令行一键安装。 |
| **推荐用户** | 追求绝对安全、稳定，用于消息归档。 | 追求实时交互，能接受第三方依赖。 |

---

## 🟢 静默模式配置指南

> **⚠️ 版本兼容性提示**
> 本功能的静默模式（特别是从内存中提取密钥的方法）经测试在 **微信 for Mac 3.8.0** 版本下可正常工作。如果遇到问题，可以考虑使用此版本。
> 你可以从以下链接下载微信的历史版本：[zsbai/wechat-versions](https://github.com/zsbai/wechat-versions/releases?page=3)。

此模式是你开箱即用的默认选项，它最安全、最稳定。

### Step 1: 获取数据库密钥 (`WECHAT_DB_KEY`) - 核心步骤

这是配置静默模式最关键、也最有技术挑战的一步。由于微信对数据进行了加密，本程序需要一个64位的密钥才能解密你的聊天记录。出于安全考虑，程序**不会**自动获取此密钥。你必须手动获取并配置它。

**请注意：获取密钥的过程涉及到对系统文件或运行中进程的操作，请在充分了解风险后，谨慎操作。**

以下是几种主流的密钥获取方法：

#### 方法 A：从iPhone手机备份中提取 (最安全、最推荐)

此方法通过读取iPhone在电脑上的本地备份文件来获取密钥，不直接与运行中的微信交互，因此最为安全可靠。它依赖一个名为 `wx_export` 的Python工具。

**前提条件**:
-   你的电脑上已经安装了 Python 3。
-   你的iPhone和Mac在同一个Wi-Fi网络下，或者通过数据线连接。

**操作流程**:

1.  **安装 `wx_export` 工具**:
    打开终端，运行以下命令来安装：
    ```bash
    pip3 install wx_export
    ```

2.  **为iPhone创建本地备份**:
    *   使用数据线将iPhone连接到Mac。
    *   打开“访达”(Finder)，在侧边栏中选择你的iPhone。
    *   在“通用”标签页下，选择“将iPhone上所有数据备份到此Mac”。
    *   **关键**: **不要**勾选“给本地备份加密”选项。
    *   点击“立即备份”，并等待备份完成。

    > **⚠️ 关于磁盘空间的提示**
    > iPhone的完整备份可能会占用大量磁盘空间。苹果的备份功能不支持只备份单个App，因此你无法只备份微信。如果你的Mac磁盘空间不足，可以考虑在备份前将照片、视频等大文件转移，或将备份位置重定向到一个外置硬盘。

3.  **运行 `wx_export` 提取密钥**:
    *   保持iPhone与Mac的连接。
    *   打开一个新的终端窗口，直接运行以下命令：
    ```bash
    wx_export
    ```
    *   程序会自动查找并扫描本地的iPhone备份文件。
    *   成功后，它会输出你的微信基本信息以及数据库密钥。

4.  **找到并复制密钥**:
    在 `wx_export` 的输出信息中，找到类似下面这样的一行：
    ```
    [*] KEY: [一个64位的长字符串]
    ```
    这个64位的字符串就是你需要的 `WECHAT_DB_KEY`。请将它复制下来。

- **优点**: 安全，成功率高，不受微信版本更新影响。
- **缺点**: 需要有iPhone和足够的磁盘空间来创建备份。

#### 方法 B：从macOS客户端内存中提取 (技术要求高)

此方法通过技术手段直接从正在运行的macOS微信客户端内存中读取密钥，适用于熟悉命令行的用户。操作有一定技术门槛，且可能因微信版本更新而失效。

最核心的方法是使用macOS自带的调试工具`lldb`，在微信启动时设置断点来捕获密钥。具体步骤如下：

1.  打开`终端` (Terminal)。
2.  启动微信，但**不要登录**，停留在扫码界面。
3.  在终端中输入 `lldb -p $(pgrep WeChat)` 并回车，将调试器附加到微信进程。
4.  接着输入 `br set -n sqlite3_key` 并回车，为密钥函数设置断点。
5.  输入 `c` 并回车，让微信进程继续运行。
6.  现在，在微信界面上扫码登录。
7.  登录成功后，回到终端，此时它应该停在断点处。根据你的Mac芯片类型，输入对应命令并回车：
    *   **Intel 芯片**: `memory read --size 1 --format x --count 32 $rsi`
    *   **Apple 芯片 (M1/M2/M3)**: `memory read --size 1 --format x --count 32 $x1`
8.  终端会输出一块内存地址，其中包含的就是64位的密钥。

社区中有很多优秀的教程也介绍了此方法，并提供了详尽的图文步骤，你可以进一步参考：

- **少数派教程**: [《导出多年微信聊天记录，我们找到了这些方法》](https://sspai.com/post/82577)
- **ChatCopilot文档**: [《mac数据库解密》](https://github.com/lw396/ChatCopilot/blob/main/doc/mac%E6%95%B0%E6%8D%AE%E5%BA%93%E8%A7%A3%E5%AF%86.md)

最终，你应该会得到一个 **64位的十六进制字符串**，这就是你的 `WECHAT_DB_KEY`。

### Step 2: 安装依赖

你需要在系统上安装 `sqlcipher`，这是一个用于解密数据库的命令行工具。

```bash
brew install sqlcipher
```

如果未安装 `brew`，请先访问 [Homebrew官网](https://brew.sh/index_zh-cn) 进行安装。

### Step 3: 配置环境变量

将你获取到的密钥配置到 `.env` 文件中。

1.  在项目根目录下，如果不存在 `.env` 文件，请创建一个。
2.  在 `.env` 文件中添加以下内容：

    ```dotenv
    # ... 其他配置，如OPENAI_API_KEY ...

    # Mac微信数据库密钥
    WECHAT_DB_KEY=这里替换成你获取到的64位密钥
    ```

### Step 4: 运行

完成以上步骤后，即可正常启动程序。`mac_wechat` 通道将自动以静默模式运行。

```bash
python app.py
```

---

## 🔵 Hook模式配置指南

此模式功能更强大，但依赖于一个第三方工具。请确保你了解并信任该工具。

### Step 1: 安装并配置 WeChatTweak-macOS

本项目不直接进行Hook，而是依赖于成熟的开源工具 `WeChatTweak-macOS`。

1.  **安装命令行工具**:
    ```bash
    brew install sunnyyoung/repo/wechattweak-cli
    ```

2.  **安装并注入Tweak**:
    *   在运行此命令前，请**完全退出**微信。
    *   此操作需要管理员权限 (`sudo`)，因为它会修改 `/Applications/WeChat.app` 的内容。
    ```bash
    sudo wechattweak-cli install
    ```

3.  **验证安装**:
    *   重新打开微信。
    *   如果菜单栏出现 `微信小助手` 的选项，说明Tweak已成功注入。

### Step 2: 配置环境变量

要启用本项目的Hook模式，需要在 `.env` 文件中添加一个环境变量。

1.  打开项目根目录下的 `.env` 文件。
2.  添加或修改以下变量：

    ```dotenv
    # 设置为true以启用Hook模式
    MAC_WECHAT_USE_HOOK=true

    # 如果你之前为静默模式设置了WECHAT_DB_KEY，在Hook模式下可以不设置它
    # WECHAT_DB_KEY=...
    ```

### Step 3: 运行

现在，你可以正常启动程序。`mac_wechat` 通道将以Hook模式运行，并开始实时监听新消息。

```bash
python app.py
```

## 故障排查

- **静默模式启动失败**:
  - **检查 `WECHAT_DB_KEY`**: 确认环境变量已设置，且密钥是完整的64位。这是最常见的失败原因。
  - **检查 `sqlcipher`**: 确认已通过`brew`成功安装。在终端输入 `which sqlcipher` 应该能看到路径。
  - **查看日志**: `logs/` 目录下的日志文件会包含详细的错误信息。

- **Hook模式启动失败**:
  - **确认 `WeChatTweak-macOS` 已安装**: 确保微信菜单栏有 `微信小助手` 选项。
  - **确认环境变量**: 检查 `.env` 文件中 `MAC_WECHAT_USE_HOOK` 是否为 `true`。
  - **Tweak日志**: `WeChatTweak-macOS` 会在 `~/Library/Containers/com.tencent.xinWeChat/Data/Library/Caches/` 目录下生成自己的日志文件，可以查看它是否正常工作。 